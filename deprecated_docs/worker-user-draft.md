# WorkerScript 言語仕様ドラフト (worker.md)

## 1. はじめに

WorkerScriptは、RVTL言語をベースに、グリッドワーカーアプリケーションのスクリプト実行環境として特化させた、シンプルなインタプリタ言語です。RVTLの持つ強力な機能の一部を簡略化し、特定の用途に最適化されています。

## 2. 基本概念

*   **実行モード:**
    *   **スクリプト実行:** テキストボックスに入力されたコードは、プログラムとして扱われ、明示的に実行されます。すべてのステートメントはプログラムの一部として解釈されます。
*   **行構造:**
    *   各行はステートメントで構成されます。
    *   行番号は使用せず、ラベルによるジャンプのみをサポートします。
    *   最大行長はRVTLに準じますが、ここでは特に制限しません。
*   **コメント:** `\` で始まる行はコメントとして扱われます。RVTLのコメント形式に準じます。
*   **エラー処理:** RVTLと同様に、明示的なエラーメッセージは最小限とし、不正な構文は可能な限り評価を試みます。

## 3. データ型

*   **数値:** 0から65535までの16ビット符号なし整数。RVTLと同様です。
*   **文字列:** ダブルクォーテーション (`"`) で囲まれたテキスト。

## 4. 変数

*   **ユーザー変数:** 単一の大文字アルファベット (A-Z) が16ビット変数 (0-65535) として使用されます。RVTLと同様です。
*   **システム変数:** RVTLのシステム変数の一部はサポートされますが、入出力やファイル操作に関連するものは削除されます。
    *   `#`: 現在の実行位置を示すシステム変数。ラベルジャンプの際に更新されます。
    *   `%`: 直前の割り算の余り。
    *   `'`: ランダム数 (0-65535)。
    *   `*`: メモリサイズ（RVTLの定義に準拠）。
    *   `&`: プログラムバッファの次の利用可能バイト（RVTLの定義に準拠）。

## 5. 演算子

RVTLと同様の演算子をサポートします。

*   **算術演算:** `+`, `-`, `*`, `/`
*   **比較演算:** `=`, `>`, `<`, `>=`, `<=`, `<>` (それぞれ真の場合は1、偽の場合は0を返します)。
*   **論理演算:** `AND`, `OR`, `NOT` (RVTLに存在する場合、または必要に応じて追加)。
*   **文字列連結:** `+` 演算子で文字列を連結します。
*   **演算順序:** 括弧 `()` を使用して優先順位を変更できます。括弧がない場合は、左から右へ評価されます。

## 6. コマンド (ステートメント)

RVTLのコマンドをベースに、WorkerScript独自の仕様に合わせて調整します。

ステートメントは `<変数>=<式>` [ `<変数>=<式>` ]* という字句構造で、
変数が記号の場合は特殊なコマンドとみなされます。


また、特定の役割を果たす変数(X,Y)もあります。

* 1文字のコマンド + `=` + パラメータという形でそれぞれ空白を入れずに記述します。
* 1行の中に複数のステートメントを空白区切りで記述できます。(マルチステートメント)
    空白で区切った複数の文は左から右の順序で実行されます。
* IF文の条件式が真の場合に実行される文を書くのはマルチステートメントを使っています。
    IF文の正確な機能は「条件式が偽の場合は次の行に制御を移す」となります。

### 6.1. 出力コマンド

*   **`LOG -> "<文字列リテラル>"`**: 文字列リテラルをトランスクリプトエリアに出力します。
    *   構文: `"文字列リテラル"`
    *   例: `"Hello, Worker!"`
*   **`PRINT -> ?=<式>`**: 式の値を数字として出力します。
    *   例: `?=A`
*   **改行:** `/` 一文字で改行を挿入します。
    *   例: `"First line" /`
    *   例: `"Second line"` (改行なし)
    *   例: `"Third line" / "Fourth line" /`

### 6.2. 制御フローコマンド

行番号の代わりにラベルを使用します。ラベルはハット(`^`)で始まり英数字とアンダースコアで構成されます。

*   **`GOTO -> #=<ラベル>`:** 指定したラベルに無条件でジャンプします。
    *   例: `#=START_LOOP`
*   **`IF -> ;=<条件> #=<ラベル>`:** 条件が真 (1) の場合に指定したラベルにジャンプします。
    *   例: `;=A>10 #=^END_PROCESS`
*   **`GOSUB -> !=<ラベル>`:** 指定したラベルにジャンプし、サブルーチンとして実行します。リターンアドレスはシステム変数 `#` に保存されます。
    *   例: `!=CALCULATE_SUM`
*   **`RETURN -> ]`:** `GOSUB` で呼び出されたサブルーチンから、呼び出し元のアドレス (`#` に保存されている値) に戻ります。
    *   例: `]`
*   **`STOP -> #=-1`:** プログラムの実行を停止します。
    *   例: `#=-1`
*   **`FOR -> <変数>=<開始値>,<終了値>]`:** ループを開始します。RVTLの構文に準じます。
    *   例: `I=0,99`
*   **`NEXT -> @=<変数>+<増分>`:** FORループの次のイテレーションに進みます。
    *   例: `@=I+1`

### 6.3. グリッドアクセスコマンド

変数XとYを座標として、特殊変数 `*` への読み書きでグリッドにアクセスできます。

*   **`読み込み`:** 指定したアドレスから16ビット値を読み込み、変数に代入します。
    *   構文: `<変数>=*`
    *   例: `X=0 Y=0 A=*`
*   **`V=<値>`:** 指定したグリッドセルに16ビット値を書き込みます。
    *   構文: `*=<値式>`
    *   例: `X=1 Y=1 *=A`

### 6.4. システムコマンド

RVTLから、入出力やファイル操作に関連するコマンドは削除されます。

*   **`乱数 -> '`:** `'`を参照することで `Math.random()` の値を得ることができます。
    *   構文: `<変数>='`
    *   例: `A='`

### 6.5. コメント

*   **`REM -> :`**: コメント行を示します。
    *   例: `: This is a comment`

## 7. ラベル定義

ラベルは、プログラム内の特定の場所を示すために使用されます。
*   ラベルはハット(`^`)で始まり、英数字とアンダースコア (`_`) で構成されます
*   ラベルは行の先頭に記述されます。
*   例:
    ```
    ^MY_LABEL
    "This is my label."
    ```

## 8. 入出力とファイル操作の制限

*   **文字入出力:** サポートされません。
*   **ファイル入出力:** サポートされません。
*   **トランスクリプト出力:** 文字列リテラルの出力、`?=<式>` による数値出力と `/` による改行をサポートします。

## 9. 例

```workerscript
: WorkerScript Example Program

"--- WorkerScript Interpreter ---" /
"Initializing..." /

: Define some variables
A=10
B=20

: Perform calculation
C=A+B
"Sum of A and B: " + C /

: Conditional jump
;=C>25 #=^GREATER_THAN_25

"C is not greater than 25." /

GOTO ^END_PROGRAM

^GREATER_THAN_25
    "C is greater than 25." /
    : Example of PEEK/POKE (assuming memory address 1000 is available)
    : POKE 1000, C
    : D = PEEK(1000)
    : LOG "Value from memory address 1000: " + D /

^END_PROGRAM
    "Program finished." /
    #=-1

: This is a subroutine example (not called in this simple example)
^MY_SUBROUTINE
    "Inside subroutine." /
    ]
```

---
**注記:** この仕様はRVTLのドキュメントをベースに、ユーザーの要求（入出力の制限、ラベルの使用、改行文字）を反映させたドラフトです。実際のRVTLの仕様詳細については、提供されたURLを参照してください。
