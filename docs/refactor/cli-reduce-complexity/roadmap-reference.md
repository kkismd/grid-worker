# ESLint警告改善ロードマップ

## 現状
- **総警告数**: 63件（0 errors, 63 warnings）
- **完了済み**: max-depth警告 4件を解消 ✅

## 警告の分類と優先度

### 🔴 Phase 1: 高優先度（即座に改善可能）

#### 1-1. CLI引数解析の分割 (cli.ts)
**対象**: `parseArgs`関数
- 複雑度: 47 → 目標: 15以下
- 行数: 118行 → 目標: 100行以下
- **推定工数**: 2-3時間
- **アプローチ**: 
  - ヘルプ表示を別関数に
  - 各オプション処理を別関数に
  - サブコマンド処理を別関数に

#### 1-2. CLIメイン処理の分割 (cli.ts)
**対象**: `main`関数
- 複雑度: 27 → 目標: 15以下
- ステートメント数: 42 → 目標: 30以下
- **推定工数**: 1-2時間
- **アプローチ**:
  - 初期化処理を別関数に
  - 各実行モードの処理を別関数に

**Phase 1合計**: 3-5時間、警告削減: 4件

---

### 🟡 Phase 2: 中優先度（パーサー/レキサーの改善）

#### 2-1. Lexerのさらなる分割 (lexer.ts)
**対象**: `tokenizeLine`メソッド
- 現状: 224行、複雑度48、ステートメント169
- **推定工数**: 3-4時間
- **アプローチ**:
  - 文字リテラル処理をヘルパーに
  - ラベル定義処理をヘルパーに
  - 演算子処理をヘルパーに
  - コメント処理をヘルパーに

**期待される改善**:
- 行数: 224 → 150行以下
- 複雑度: 48 → 30以下
- ステートメント: 169 → 100以下

#### 2-2. Parser主要メソッドの分割 (parser.ts)

##### 2-2-1. `parseStatementFromTokens`
- 複雑度: 24、行数: 122、ステートメント: 54
- **推定工数**: 2-3時間
- **アプローチ**: 各ステートメントタイプの処理を別メソッドに

##### 2-2-2. `parsePrimaryExpression`
- 複雑度: 27、行数: 104、ステートメント: 45
- **推定工数**: 2-3時間
- **アプローチ**: 各式タイプの処理を別メソッドに

##### 2-2-3. `parseArrayStatement`
- 複雑度: 23、ステートメント: 43
- **推定工数**: 1-2時間
- **アプローチ**: 配列要素処理を別メソッドに

##### 2-2-4. `parseStatementString`
- 複雑度: 28、行数: 101、ステートメント: 52
- **推定工数**: 2-3時間
- **アプローチ**: 文字列パース処理を段階的に分割

##### 2-2-5. `splitLineByWhitespace`
- 複雑度: 17、ステートメント: 46
- **推定工数**: 1-2時間
- **アプローチ**: 状態管理を明確化、各状態処理を分離

##### 2-2-6. `collectIfBlock`
- ステートメント: 32 → 目標: 30以下
- **推定工数**: 1時間
- **アプローチ**: IF文収集ロジックの整理

**Phase 2合計**: 12-19時間、警告削減: 19件

---

### 🟢 Phase 3: 低優先度（その他の複雑度）

#### 3-1. workerInterpreter.ts
**対象**: `evaluateBinaryExpression`
- 複雑度: 26 → 目標: 15以下
- **推定工数**: 2-3時間
- **アプローチ**: 演算子タイプごとに別メソッドに分割

#### 3-2. cliRunner.ts
**対象**: `executeScript`
- 複雑度: 18、ステートメント: 31
- **推定工数**: 1-2時間
- **アプローチ**: エラーハンドリングと実行フローを分離

#### 3-3. RealTimeCLIRunner.ts
- `executeRealTime`: ステートメント: 37
- `runFrameLoop`: ステートメント: 34
- **推定工数**: 2-3時間
- **アプローチ**: 初期化と実行ループを分離

#### 3-4. その他の軽微な複雑度
- `index.ts`: Arrow function (複雑度16)
- **推定工数**: 30分-1時間

**Phase 3合計**: 5.5-9時間、警告削減: 9件

---

### 🔵 Phase 4: TypeScript型安全性の向上

#### 4-1. any型の段階的な置き換え（36件）

**ファイル別内訳**:
- `workerInterpreter.ts`: 15件
- `parser.ts`: 13件
- `RealTimeCLIRunner.ts`: 3件
- `cliRunner.ts`: 2件
- `index.ts`: 2件
- その他: 1件
- **合計**: 36件

**アプローチ**:
1. **ステップ1**: 型定義の作成
   - スタック値型（union type）
   - ASTノード型の拡充
   - 推定工数: 2-3時間

2. **ステップ2**: `workerInterpreter.ts`の型改善
   - スタック操作の型付け
   - 評価メソッドの型付け
   - 推定工数: 3-4時間

3. **ステップ3**: `parser.ts`の型改善
   - パース結果の型明確化
   - 推定工数: 3-4時間

4. **ステップ4**: その他ファイルの型改善
   - 推定工数: 2-3時間

**Phase 4合計**: 10-14時間、警告削減: 36件

---

## 推奨実施順序

### Sprint 1（目標: 1週間、5-8時間）
1. ✅ **完了**: lexer.ts max-depth解消
2. **次**: CLI関連の改善（Phase 1）
   - `parseArgs`の分割
   - `main`の分割

**期待効果**: 警告 63件 → 59件

---

### Sprint 2（目標: 2週間、12-19時間）
1. **Lexerのさらなる改善**（Phase 2-1）
2. **Parserの主要メソッド分割**（Phase 2-2の一部）
   - `parseStatementFromTokens`
   - `parsePrimaryExpression`
   - `collectIfBlock`

**期待効果**: 警告 59件 → 49件程度

---

### Sprint 3（目標: 2週間、10-15時間）
1. **Parser残りのメソッド分割**（Phase 2-2の残り）
2. **その他の複雑度改善**（Phase 3）

**期待効果**: 警告 50件 → 35件程度

---

### Sprint 4（目標: 2-3週間、10-14時間）
1. **型安全性の向上**（Phase 4）
   - 段階的にany型を置き換え

**期待効果**: 警告 35件 → 10件程度

---

## 注意事項とリスク

### ⚠️ リファクタリング時の注意点
1. **テストカバレッジの確認**
   - 各メソッドに対応するテストが存在するか確認
   - 不足している場合はテスト追加を優先

2. **段階的な実施**
   - 1つのメソッドを分割 → テスト → コミット
   - 一度に複数ファイルを変更しない

3. **既存の動作を維持**
   - リファクタリングで機能を変更しない
   - テストが全てパスすることを確認

### 🤔 改善しない選択肢も検討すべきケース

#### パーサー/レキサーの複雑度
- 言語実装の性質上、ある程度の複雑さは避けられない
- テストでカバーされていれば保守性は担保される
- **代替案**: ESLintルールの調整
  ```javascript
  // parser.ts, lexer.ts に対して緩和
  overrides: [{
    files: ['src/lexer.ts', 'src/parser.ts'],
    rules: {
      'complexity': ['warn', { max: 30 }],
      'max-lines-per-function': ['warn', { max: 150 }],
    }
  }]
  ```

#### CLI引数解析
- コマンドラインツールとして妥当な複雑さ
- ただし、Phase 1は実施推奨（改善効果が高い）

---

## 最終目標

### 楽観的シナリオ（全Phase実施）
- **期間**: 6-8週間
- **工数**: 37.5-58時間
- **警告数**: 63件 → 0件（理論上）
- **削減率**: 100%（理論上）

### 現実的シナリオ（Phase 1-3実施）
- **期間**: 4-5週間
- **工数**: 20.5-33時間
- **警告数**: 63件 → 27件程度
- **削減率**: 57%程度

### ミニマルシナリオ（Phase 1のみ実施）
- **期間**: 1週間
- **工数**: 3-5時間
- **警告数**: 63件 → 59件
- **削減率**: 6%
- **メリット**: CLIの可読性向上、最も使われる部分の改善

---

## 次のアクション

どのPhaseから開始しますか？

1. **Phase 1（CLI改善）**: すぐに効果が出る、ユーザー影響大
2. **Phase 2（Parser/Lexer）**: コア機能の品質向上
3. **Phase 4（型安全性）**: 長期的な保守性向上

推奨: **Phase 1から順番に実施**
