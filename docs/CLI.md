# Grid Worker - WorkerScript CLI

WorkerScript言語のCLI実行環境です。100x100のグリッドをターミナルで操作できます。

## 🚀 CLIモードの使用方法

### インストール

```bash
npm install
```

### スクリプトファイルの実行

```bash
# 基本実行（デフォルト: runサブコマンド）
npm run cli examples/hello.ws
npm run cli run examples/hello.ws  # runは省略可

# リアルタイムモード（30fps、キーボード入力対応）
npm run cli -- examples/hello.ws --realtime

# グリッド表示付きリアルタイム実行
npm run cli -- examples/pattern.ws --realtime --show-grid

# キャラクターVRAMモード（ASCII文字+ANSIカラー表示）
npm run cli -- examples/realtime_tests/06-color-text.ws --realtime --show-grid --char-mode
# または短縮形
npm run cli -- examples/realtime_tests/06-color-text.ws --realtime --show-grid -c

# 詳細モード
npm run cli -- examples/pattern.ws --verbose

# デバッグモード  
npm run cli -- examples/square.ws --debug

# 出力をファイルに保存
npm run cli -- examples/hello.ws --output result.json
```

### サブコマンドシステム

CLIは目的別のサブコマンドをサポートし、各サブコマンドには最適化されたデフォルト設定があります。

```bash
# 通常実行（デフォルト）
npm run cli run examples/hello.ws

# テキスト出力専用（パイプライン向け、グリッド表示なし）
npm run cli exec examples/data.ws | jq

# デバッグ実行（詳細ログ + デバッグ情報）
npm run cli debug examples/test.ws

# リアルタイム監視（分割画面 + グリッド + トランスクリプト）
npm run cli watch examples/pattern.ws

# テキストゲーム/対話処理（グリッドなしリアルタイム）
npm run cli text examples/text-game.ws

# グリッドゲームモード（高応答性 + グリッド表示）
npm run cli play examples/game.ws

# インタラクティブモード（REPL）
npm run cli repl

# ベンチマーク実行（統計情報表示）
npm run cli bench examples/benchmark.ws
```

**サブコマンド別デフォルト設定:**

| サブコマンド | リアルタイム | グリッド表示 | 詳細モード | 目的 |
|------------|------------|------------|-----------|------|
| `run`      | OFF        | OFF        | OFF       | 通常実行 |
| `exec`     | OFF        | OFF        | OFF       | パイプライン向け（--no-grid自動設定） |
| `debug`    | OFF        | OFF        | ON        | デバッグ実行 |
| `watch`    | ON         | ON         | OFF       | リアルタイム監視（分割画面） |
| `text`     | ON         | OFF        | OFF       | テキストゲーム |
| `play`     | ON         | ON         | OFF       | グリッドゲーム |
| `repl`     | OFF        | OFF        | OFF       | 対話実行 |
| `bench`    | OFF        | OFF        | OFF       | ベンチマーク |

**オプション優先順位:** CLI引数で明示的に指定したオプションは、サブコマンドのデフォルト設定より優先されます。

```bash
# watchサブコマンドでもグリッド表示を無効化
npm run cli watch examples/test.ws --no-grid
```

### 主要オプション

**基本オプション:**
- `-h`, `--help` - ヘルプを表示
- `-i`, `--interactive` - インタラクティブ（REPL）モード
- `-d`, `--debug` - デバッグ情報を表示
- `-v`, `--verbose` - 詳細なログを出力
- `-o`, `--output FILE` - 出力をファイルに保存
- `-q`, `--quiet` - 進捗表示を無効化（クリーンな出力）

**実行制御:**
- `-u`, `--unlimited` - ステップ数無制限で実行
- `-m`, `--max-steps N` - 最大ステップ数を指定（デフォルト: 100000）

**リアルタイムモード:**
- `-r`, `--realtime` - リアルタイム実行モード（30fps、Raw Mode、キーボード入力対応）
- `--fps N` - フレームレート指定（デフォルト: 30）
- `--steps-per-frame N` - 1フレームあたりの実行ステップ数（デフォルト: 1000）
- `--show-fps` - FPS表示を有効化

**グリッド表示:**
- `-g`, `--show-grid` - グリッド表示を有効化（リアルタイムモード専用）
- `--no-grid` - グリッド表示を抑制（テキスト出力のみ）
- `-s`, `--split-screen` - 上下分割画面モード（グリッド+トランスクリプト）
- `--grid-size N` - グリッド表示サイズ（デフォルト: 20x20）

**キャラクターVRAMモード:**
- `-c`, `--char-mode` - キャラクターVRAMモード（16ビット値をASCII+カラーとして表示）
  - グリッド値（0-65535）を16ビット値として解釈
  - ビット 0-7: ASCII文字コード
  - ビット 8-11: 前景色（0-15、ANSI 16色）
  - ビット 12-15: 背景色（0-15、ANSI 16色）
  - エンコーディング計算式: `value = ASCII + (fg_color * 256) + (bg_color * 4096)`
  - 16進数リテラル使用例: `0x7148` = 'H'（0x48） + 前景色1（赤） + 背景色7（白）

### インタラクティブモード

```bash
npm run cli -- --interactive
```

インタラクティブモードでは以下のコマンドが使用できます：

- `.exit` - 終了
- `.clear` - グリッドとトランスクリプトをクリア
- `.grid` - 現在のグリッド状態を表示
- `.help` - ヘルプを表示

## 📝 WorkerScript 言語仕様

### 基本構文

```workerscript
: コメント
A=10           : 変数Aに10を代入
B=0xFF         : 16進数リテラル（10進数255）
C=0x1A2B       : 16進数リテラル（10進数6699）
?="Hello"      : 文字列を出力
?=A            : 変数Aの値を出力
/              : 改行を出力
D='A'          : 文字リテラル（ASCII値65）
E='''          : シングルクォート文字（ASCII値39）
```

### 数値リテラル

- **10進数**: `123`, `0`, `-45`
- **16進数**: `0xFF`, `0x1A2B`, `0X7FFF`（`0x`または`0X`で始まる）
  - 大文字・小文字の16進数字をサポート
  - 例: `0xABCD`, `0xabcd`, `0xAbCd` すべて有効
  - 内部的には10進数に変換されて処理される

### グリッド操作

```workerscript
: 座標系: X=左右方向(列), Y=上下方向(行)
: (0,0)は左上、(99,99)は右下

X=5 Y=10       : 座標を設定（右に5、下に10）
`=255          : 現在座標にピクセルを設定（グレースケール）
`=0x7148       : キャラクターVRAMモード: 'H'+カラー
A=`            : 現在座標の値を読み取り
```

### キャラクターVRAMモードでの値のエンコーディング

```workerscript
: 16ビット値 = ASCII + (前景色 * 256) + (背景色 * 4096)
: または 16進数で: ASCII + (fg_color << 8) + (bg_color << 12)

: 例1: 'H' を白背景・赤文字で表示
X=0 Y=0
`=0x7148       : 0x48('H') + 0x0100(赤) + 0x7000(白bg)

: 例2: 計算式で同じ結果
`='H' + 256 + 7*4096

: ANSI 16色:
: 0:黒, 1:赤, 2:緑, 3:黄, 4:青, 5:マゼンタ, 6:シアン, 7:白
: 8-15: 明るいバリエーション
```

### 制御構造

#### インラインIF（1行形式）
```workerscript
: IF文（条件が真の時のみ実行）
;=A>10 ?="大きい" /
```

#### ブロックIF（複数行形式）
```workerscript
: ブロックIF-ELSE-FI構造
A=10
;=A>5
  ?="A is greater than 5"
  /
;
  ?="A is not greater than 5"
  /
#=;

: ELSE部なしのブロックIF
B=3
;=B=3
  ?="B equals 3"
  /
#=;

: ブロックIFのネスト
;=A>0
  ;=B>0
    ?="Both positive"
    /
  #=;
#=;
```

**ブロックIF構造の特徴:**
- `;=<条件>` が単独で行にある場合、ブロックIF構造として解釈
- 条件が真（0でない値）の場合、THEN部（`;=` から `;` まで）のステートメントを実行
- 条件が偽（0）の場合、ELSE部（`;` から `#=;` まで）のステートメントを実行
- ELSE部は省略可能（`;` の行を省略すると、ELSE部なしのIF文になります）
- `#=;` でブロックを終了（統一構文パターン：FOR/WHILEの `@=...#=@` と同様）
- ブロックIFは入れ子にできます

#### FORループ（統一構文）
```workerscript
: FORループ（@= で開始、#=@ で終了）
@=I,1,10
  ?=I /
#=@
```

#### WHILEループ（統一構文）
```workerscript
: WHILEループ（@= で開始、#=@ で終了）
@=(X<100)
  X=X+1
#=@
```

#### GOTO/GOSUB/RETURN
```workerscript
: GOTO/GOSUB（統一構文）
#=^MYLABEL     : ラベルにジャンプ
!=^MYSUB       : サブルーチン呼び出し
#=!            : サブルーチンから復帰（RETURN）

^MYLABEL
  ?="ラベル" /

^MYSUB
  ?="サブルーチン" /
  #=!
```

## 📊 出力例

### ASCII グリッド表示

```
📊 グリッド状態:
   0 1 2 3 4 5 6 7 8 9  ← X座標（列番号）
   -------------------
0 |░ . . . . . . . . .  ← Y座標（行番号）
1 |. ░ . . . . . . . .  
2 |. . ░ . . . . . . .
3 |. . . ░ . . . . . .
4 |. . . . ░ . . . . .
5 |. . . . . ░ . . . .
6 |. . . . . . ░ . . .
7 |. . . . . . . ░ . .
8 |. . . . . . . . ░ .
9 |. . . . . . . . . ░
```

- **上部の数字**: X座標（0-9列目）
- **左側の数字**: Y座標（0-9行目）

### 記号の意味

- `.` : 空白（値0）
- `░` : 薄い（値1-32）
- `▒` : 中間薄い（値33-96）
- `▓` : 中間濃い（値97-160）
- `█` : 濃い・最大（値161-255）

## 🎯 サンプルスクリプト

### examples/hello.ws
基本的な出力とピクセル設定のテスト

### examples/pattern.ws  
FORループを使った対角線パターン

### examples/square.ws
複数のループを使った正方形描画

### examples/mandelbrot.ws
FORループを使ったマンデルブロ集合のASCIIアート（78×20、記号文字使用）

### examples/mandelbrot-tinybasic.ws
TinyBasicアルゴリズムベースのマンデルブロ集合（79×25、0-9A-F文字使用）

#### マンデルブロ集合 - TinyBasic版

TinyBasicの歴史的なマンデルブロ実装を忠実に移植したバージョンです。

**実行例:**
```bash
npm run cli -- examples/mandelbrot-tinybasic.ws --unlimited --quiet
```

**出力結果:**
```
TinyBasicマンデルブロ開始
222222222222222333333333333344444567D9F 544433333333222222222222211111111111111
222222222223333333333333344444555778FC97654444333333322222222222221111111111111
222222223333333333333344444455566     E 765544443333332222222222222111111111111
222223333333333333344444455566678B     D866655544433333222222222222211111111111
2223333333333334444444555799 88AAAD    DA9D766786543333322222222222221111111111
22333333333444444444555567D  E             CAED  544333332222222222221111111111
33333333444545555555556689B                     7644433332222222222222111111111
33333344455 766666666678B                      C8654433333222222222222211111111
333344445568B9A9 C88888C                          65443333222222222222211111111
3444445566789  F  D  ABD                         854433333322222222222211111111
44455566878B          D                          854443333322222222222211111111
56666777ADEE                                    9654443333322222222222211111111
                                              B87654443333322222222222221111111
55666667A DC                                   E8654443333322222222222221111111
444455567788D                                    755443333322222222222221111111
3444445556679E        CF                         F65443333322222222222211111111
333344445567 AA9A B 899A                         F65433333322222222222211111111
333333444556C76667777778AC                      AA55433333222222222222211111111
333333334444555555556667                       B8654433333222222222222211111111
223333333334444444455555679                 F   D744433332222222222222211111111
22233333333333344444445556F  9A           CE888B7544333322222222222222111111111
222222333333333333344444555666778A      B87655555443333322222222222221111111111
222222223333333333333444444555567A       76554444333333222222222222221111111111
22222222222333333333333344444555578BD D7765444433333322222222222222111111111111
222222222222223333333333333444445568 BF 654443333333222222222222222111111111111
完了
```

**特徴:**
- **アルゴリズム**: 1980年代TinyBasicの歴史的実装を忠実に再現
- **画面サイズ**: 79文字×25行（クラシックな80桁ターミナル対応）
- **固定小数点**: F=50スケールによる整数演算
- **文字セット**: 反復回数に応じて `0-9` および `A-F` で表現
- **座標系**: X=-39～39、Y=-12～12の複素平面マッピング
- **実装方式**: GOTO/ラベルジャンプによる原典忠実なループ構造

この実装は、GAME言語の符号比較バグを回避し、より安定したTinyBasicアルゴリズムをベースとしています。

## 🛠️ 開発者向け

### ビルド

```bash
npm run build
```

### テスト実行

```bash
npm test
```

### 新しいサンプル作成

`examples/`ディレクトリに`.ws`拡張子でファイルを作成してください。

## 📚 関連ドキュメント

- [spec.md](spec.md) - プロジェクト仕様
- [worker.md](worker.md) - WorkerScript言語仕様
- [src/](src/) - ソースコード