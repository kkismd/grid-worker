# プログラム仕様書

## 目的

画面上にcanvasでできた100x100のグリッドを表示し、ひもづいている配列を複数のWorkerScriptから操作することで表示を変化させるプログラム。

## 概要

### UIレイアウト

画面は以下の要素で構成される。

1.  **Canvas:** 400x400pxのグリッド表示領域。
2.  **グローバルコントロール:**
    *   **Speed Control:** 実行速度を調整するスライダー（1-100 steps/sec）
    *   **Clock:** 現在の実行ステップ数を表示
3.  **ワーカーエリア:** 複数のWorkerScriptを管理するエリア。各ワーカーは以下で構成される：
    *   **テキストエリア:** ユーザーがスクリプトを入力する領域
    *   **実行/停止ボタン:** テキストエリアのスクリプトを実行または停止する
    *   **保存ボタン:** 現在テキストエリアにあるWorkerScriptをローカルストレージに保存する
    *   **読み込み/削除エリア:** 保存されているスクリプトのタイトル一覧を表示し、選択したスクリプトをテキストエリアに読み込む「読み込み」ボタン、または削除する「削除」ボタンを提供
    *   **Clone 1st Workerボタン:** Worker 1のスクリプトを現在のワーカーにコピーする
4.  **トランスクリプトエリア:** 各ワーカーの出力（`?=`コマンドや`/`改行）やエラーメッセージを表示する領域。

### グリッド仕様

-   **表示:** 画面上に400x400pxのcanvasを作成し、100x100のグリッドを表示する。各グリッドセルは4x4pxの大きさとなる。
-   **データ管理:** `gridData`という名前の100x100=10000の要素を持つ整数の配列がグリッドの状態を表す。
-   **色:** 配列の要素が`0`のとき対応するグリッドの点は黒になり、`1`の場合は白になる。
-   **初期状態:** プログラム開始時、グリッドはすべて黒で表示される（`gridData`の全要素が`0`）。

### スクリプト実行環境

-   **実行:** テキストエリアに書かれたWorkerScriptコードは、実行ボタンを押すことで実行される。WorkerScriptの言語仕様については、`worker.md`を参照のこと。
-   **メモリアクセス:** WorkerScriptでは、システム変数`$`を使用して`gridData`にアクセスします。座標変数`X`と`Y`を設定した後、`$`を読み書きすることで、対応するグリッドセルの値を操作できます。詳細は`worker.md`の「PEEK/POKE」セクションを参照してください。

### スクリプト実行のセマンティクス

-   WorkerScriptインタプリタは、外部からのクロック（ティック）に応じて、一度に1つのステートメントを実行します。
-   これは、インタプリタがGenerator Functionとして実装されており、メインアプリケーションがGeneratorの`next()`メソッドを呼び出すことで実現されます。
-   `next()`が呼び出されるたびに、インタプリタは次のステートメントを実行し、実行が継続可能であるかを示す値を返します。
-   スクリプトの実行が完了するか、エラーが発生した場合、Generatorは実行終了を示します。
-   このメカニズムにより、**複数のWorkerScriptを協調的マルチタスクとして同時に実行**することが可能になります。
-   各ワーカーは独立した変数スコープを持ち、共有されるのはグリッドデータ（`gridData`配列）のみです。
-   クロック速度は1〜100 steps/secの範囲で調整可能です。

-   **エラーハンドリング:** スクリプトの実行中に発生したエラーは、各ワーカーのトランスクリプトエリアに表示される。

### スクリプトの保存と読み込み

-   ユーザーはテキストエリアに入力したWorkerScriptコードを、ブラウザのローカルストレージに保存できます。
-   保存されたスクリプトは、各ワーカーごとにタイトルをキーとして管理され、一覧から選択してテキストエリアに読み込んだり、削除したりできます。
-   保存されるスクリプトの数やサイズには、ブラウザのローカルストレージの一般的な制限が適用されます。
-   「Clone 1st Worker」ボタンを使用すると、Worker 1のスクリプトを他のワーカーにコピーできます。