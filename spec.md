# プログラム仕様書

## 目的

画面上にcanvasでできた100x100のグリッドを表示し、ひもづいている配列を複数のWorkerScriptから操作することで表示を変化させるプログラム。

## 概要

### UIレイアウト

画面は以下の要素で構成される。

1.  **Canvas:** 400x400pxのグリッド表示領域。
2.  **グローバルコントロール:**
    *   **Speed Control:** 実行速度を調整するスライダー（1-100 steps/sec）
    *   **Clock:** 現在の実行ステップ数を表示
3.  **ワーカーエリア:** 複数のWorkerScriptを管理するエリア。各ワーカーは以下で構成される：
    *   **テキストエリア:** ユーザーがスクリプトを入力する領域
    *   **実行/停止ボタン:** テキストエリアのスクリプトを実行または停止する
4.  **グローバルボタン:**
    *   **Add New Worker:** 新しいワーカーを追加する
    *   **Clone 1st Worker:** Worker 1のスクリプトを現在のワーカーにコピーする
    *   **Start All:** すべてのワーカーを同時に開始する
    *   **Clear Grid:** グリッドをクリアする（全セルを黒に設定）
5.  **トランスクリプトエリア:** 各ワーカーの出力（`?=`コマンドや`/`改行）やエラーメッセージを表示する領域。

### グリッド仕様

-   **表示:** 画面上に400x400pxのcanvasを作成し、100x100のグリッドを表示する。各グリッドセルは4x4pxの大きさとなる。
-   **データ管理:** `gridData`という名前の100x100=10000の要素を持つ整数の配列がグリッドの状態を表す。
-   **色:** 配列の要素が`0`のとき対応するグリッドの点は黒になり、`1`の場合は白になる。
-   **初期状態:** プログラム開始時、グリッドはすべて黒で表示される（`gridData`の全要素が`0`）。

### スクリプト実行環境

-   **実行:** テキストエリアに書かれたWorkerScriptコードは、実行ボタンを押すことで実行される。WorkerScriptの言語仕様については、`worker.md`を参照のこと。
-   **メモリアクセス:** WorkerScriptでは、システム変数`$`を使用して`gridData`にアクセスします。座標変数`X`と`Y`を設定した後、`$`を読み書きすることで、対応するグリッドセルの値を操作できます。詳細は`worker.md`の「PEEK/POKE」セクションを参照してください。

### スクリプト実行のセマンティクス

-   WorkerScriptインタプリタは、外部からのクロック（ティック）に応じて、一度に1つのステートメントを実行します。
-   これは、インタプリタがGenerator Functionとして実装されており、メインアプリケーションがGeneratorの`next()`メソッドを呼び出すことで実現されます。
-   `next()`が呼び出されるたびに、インタプリタは次のステートメントを実行し、実行が継続可能であるかを示す値を返します。
-   スクリプトの実行が完了するか、エラーが発生した場合、Generatorは実行終了を示します。
-   このメカニズムにより、**複数のWorkerScriptを協調的マルチタスクとして同時に実行**することが可能になります。
-   各ワーカーは独立した変数スコープを持ち、共有されるのはグリッドデータ（`gridData`配列）のみです。
-   クロック速度は1〜100 steps/secの範囲で調整可能です。

-   **エラーハンドリング:** スクリプトの実行中に発生したエラーは、各ワーカーのトランスクリプトエリアに表示される。

### ワーカーの管理

-   **複数ワーカー:** 動的に複数のワーカーを追加でき、それぞれ独立したWorkerScriptを実行できます。
-   **スクリプトのコピー:** 「Clone 1st Worker」ボタンを使用すると、Worker 1のスクリプトを他のワーカーにコピーできます。
-   **共有グリッド:** すべてのワーカーは同じ`gridData`配列を共有し、協調的に同じグリッドを操作できます。
-   **独立変数:** 各ワーカーは独立した変数スコープ（A-Z）を持ちます。

**注意:** ローカルストレージへのスクリプト保存・読み込み機能は現在実装されていません。ワーカー間でのスクリプトのコピーは「Clone 1st Worker」ボタンで可能です。