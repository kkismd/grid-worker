# WorkerScript ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ å®Ÿè£…è¨ˆç”»

## ğŸ“‹ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

WorkerScriptã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã‚’æ®µéšçš„ã«è¿½åŠ ã—ã€é™çš„ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œç’°å¢ƒã‹ã‚‰å‹•çš„ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ç’°å¢ƒã¸é€²åŒ–ã•ã›ã‚‹ã€‚

**å®Ÿè£…æ–¹é‡**: MVPï¼ˆæœ€å°å®Ÿè¡Œå¯èƒ½è£½å“ï¼‰ã‹ã‚‰å§‹ã‚ã€æ®µéšçš„ã«æ©Ÿèƒ½ã‚’æ‹¡å¼µ

## ğŸ¯ å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### Phase 0: åŸºç›¤æ•´å‚™ï¼ˆæº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºï¼‰âœ…
**ç›®æ¨™**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å®Ÿè£…ã®ãŸã‚ã®åŸºç›¤ã‚’æ•´ãˆã‚‹  
**æœŸé–“**: 1-2æ—¥

- [x] é…åˆ—ãƒ»ã‚¹ã‚¿ãƒƒã‚¯æ©Ÿèƒ½ã®å®Ÿè£…å®Œäº†
- [x] MemorySpaceæŠ½è±¡åŒ–å®Œäº†
- [x] ãƒ‘ãƒ¼ã‚µãƒ¼ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ãƒ¼å®‰å®šåŒ–
- [ ] ç¾åœ¨ã®GridRunneræ§‹é€ ã®åˆ†æ
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã®è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼

### Phase 1: ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ï¼ˆMVPï¼‰âœ…
**ç›®æ¨™**: `A=$` (ä»»æ„ã®å¤‰æ•°) ã§ã‚­ãƒ¼å…¥åŠ›ã‚’å–å¾—  
**æœŸé–“**: 2-3æ—¥  
**å„ªå…ˆåº¦**: æœ€é«˜  
**çŠ¶æ…‹**: âœ… å®Œäº† (2025-10-18)

#### å®Ÿè£…å†…å®¹
```typescript
// KeyboardInput ã‚¯ãƒ©ã‚¹ã§Raw Modeåˆ¶å¾¡
class KeyboardInput {
    private keyBuffer: number[] = []  // FIFO queue (max 1000)
    
    getKey(): number {
        return this.keyBuffer.shift() || 0
    }
}

// RealTimeCLIRunner ã§ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡
class RealTimeCLIRunner {
    private config = {
        frameRate: 30,        // 30 FPS
        stepsPerFrame: 1000   // 1ãƒ•ãƒ¬ãƒ¼ãƒ 1000ã‚¹ãƒ†ãƒƒãƒ—
    }
}
```

#### æŠ€è¡“çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
1. âœ… **Raw Modeåˆ¶å¾¡**: `process.stdin.setRawMode(true)`
2. âœ… **ã‚­ãƒ¼ãƒãƒƒãƒ•ã‚¡**: FIFO queue ã§å…¥åŠ›ã‚’ä¿æŒ (max 1000)
3. âœ… **å®‰å…¨ãªçµ‚äº†**: Ctrl+C, SIGINT, exitã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
4. âœ… **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: TTYç’°å¢ƒãƒã‚§ãƒƒã‚¯
5. âœ… **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡**: 30 FPSã€async/await ã§éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°
6. âœ… **æ—¢å­˜$å¤‰æ•°æ´»ç”¨**: K=$ ã§ã¯ãªã A=$, B=$ ç­‰ã§å…¥åŠ›å—ä¿¡

#### æˆåŠŸåŸºæº–
- âœ… ã‚­ãƒ¼å…¥åŠ›ãŒ`A=$`ã§å–å¾—ã§ãã‚‹
- âœ… Ctrl+Cã§æ­£å¸¸çµ‚äº†ã§ãã‚‹
- âœ… è¤‡æ•°ã‚­ãƒ¼ã®é€£ç¶šå…¥åŠ›ã«å¯¾å¿œ
- âœ… TTYã§ãªã„ç’°å¢ƒã§ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„
- âœ… ãƒ“ã‚¸ãƒ¼ãƒ«ãƒ¼ãƒ—ãªã—ï¼ˆ30 FPSåˆ¶å¾¡ï¼‰
- âœ… CPUä½¿ç”¨ç‡ 3-10% (100%ã«ãªã‚‰ãªã„)

#### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
- âœ… `src/realtime/KeyboardInput.ts` (200è¡Œ)
- âœ… `src/realtime/RealTimeCLIRunner.ts` (233è¡Œ)
- âœ… `src/__tests__/realtime/KeyboardInput.test.ts`
- âœ… `src/__tests__/realtime/RealTimeCLIRunner.test.ts`
- âœ… `src/cli.ts` ã« --realtime ãƒ•ãƒ©ã‚°çµ±åˆ
- âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ  3å€‹æ›´æ–°

#### ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
```workerscript
: Simple Key Echo
^LOOP
    A=$
    ;=A>0 ?="Key: " ?=A /
    ;=A=27 #=^END  : ESC to exit
    #=^LOOP

^END
    ?="Program ended"
    #=-1
```

#### å®Ÿè¡Œæ–¹æ³•
```bash
npm run cli -- examples/realtime_tests/01-key-echo.ws --realtime
npm run cli -- examples/realtime_tests/03-wasd-movement.ws --realtime --show-fps
```

---

### Phase 2: ã‚°ãƒªãƒƒãƒ‰å·®åˆ†æ›´æ–°ï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«ç‰ˆï¼‰
**ç›®æ¨™**: ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã§ã‚°ãƒªãƒƒãƒ‰å·®åˆ†æç”»  
**æœŸé–“**: 3-4æ—¥  
**å„ªå…ˆåº¦**: é«˜

#### å®Ÿè£…å†…å®¹
```typescript
class GridDiffRenderer {
    private lastFrame: Int16Array
    private dirtyRegions: Set<number>
    
    // å¤‰æ›´ã•ã‚ŒãŸåº§æ¨™ã®ã¿æ›´æ–°
    renderDiff(gridData: Int16Array): string {
        const changes = this.detectChanges(gridData)
        return this.generateANSI(changes)
    }
    
    private generateANSI(changes: Change[]): string {
        let output = ''
        for (const {x, y, value} of changes) {
            // ESC[line;columnH ã§ã‚«ãƒ¼ã‚½ãƒ«ç§»å‹•
            output += `\x1b[${y+1};${x+1}H${this.valueToChar(value)}`
        }
        return output
    }
}
```

#### æŠ€è¡“çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
1. **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡**: å‰å›ã®ã‚°ãƒªãƒƒãƒ‰çŠ¶æ…‹ã‚’ä¿æŒ
2. **å·®åˆ†æ¤œå‡º**: XORæ¼”ç®—ã§ã®é«˜é€Ÿæ¯”è¼ƒ
3. **ANSIã‚¨ã‚¹ã‚±ãƒ¼ãƒ—**: ã‚«ãƒ¼ã‚½ãƒ«ç§»å‹•ã¨æ–‡å­—æç”»
4. **ãƒãƒƒãƒæœ€é©åŒ–**: é€£ç¶šé ˜åŸŸã®ã¾ã¨ã‚æç”»

#### æˆåŠŸåŸºæº–
- [ ] 100x100ã‚°ãƒªãƒƒãƒ‰ã®å·®åˆ†æ›´æ–° < 16ms
- [ ] ã¡ã‚‰ã¤ãã®ãªã„æç”»
- [ ] ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒé©åˆ‡ï¼ˆ<10MBè¿½åŠ ï¼‰

---

### Phase 3: ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡
**ç›®æ¨™**: å®‰å®šã—ãŸ30FPSå®Ÿè¡Œ  
**æœŸé–“**: 2-3æ—¥  
**å„ªå…ˆåº¦**: ä¸­

#### å®Ÿè£…å†…å®¹
```typescript
class RealTimeRunner {
    private frameRate: number = 30
    private stepsPerFrame: number
    
    async runRealTime(script: string): Promise<void> {
        const interpreter = new WorkerInterpreter(...)
        const generator = interpreter.run()
        
        this.startFrameLoop(generator)
    }
    
    private startFrameLoop(gen: Generator): void {
        const frameStart = Date.now()
        
        // 1ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†å®Ÿè¡Œ
        for (let i = 0; i < this.stepsPerFrame; i++) {
            const result = gen.next()
            if (result.done) {
                this.cleanup()
                return
            }
        }
        
        // æ¬¡ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        const elapsed = Date.now() - frameStart
        const delay = Math.max(0, 1000/this.frameRate - elapsed)
        setTimeout(() => this.startFrameLoop(gen), delay)
    }
}
```

#### æŠ€è¡“çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
1. **é©å¿œçš„ã‚¹ãƒ†ãƒƒãƒ—æ•°**: FPSç¶­æŒã®ãŸã‚ã®å‹•çš„èª¿æ•´
2. **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç®¡ç†**: é«˜ç²¾åº¦ã‚¿ã‚¤ãƒãƒ¼ä½¿ç”¨
3. **é…å»¶è£œå„Ÿ**: ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ã‚­ãƒƒãƒ—ã¨ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—

---

### Phase 4: ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆåˆ†é›¢ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
**ç›®æ¨™**: ã‚°ãƒªãƒƒãƒ‰ã¨ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ã®åˆ†é›¢è¡¨ç¤º  
**æœŸé–“**: 2-3æ—¥  
**å„ªå…ˆåº¦**: ä¸­ï¼ˆå¾Œå›ã—å¯èƒ½ï¼‰

#### ç°¡æ˜“ç‰ˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
```
â”Œâ”€ Grid (100x100) â”€â”€â”€â”€â”€â”
â”‚ (ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º)        â”‚
â”‚                       â”‚
â”œâ”€ Transcript â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ > Output line 1       â”‚
â”‚ > Output line 2       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ MVPå®Ÿè£…ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆPhase 1 Focusï¼‰

### å¿…é ˆæ©Ÿèƒ½
1. âœ… `K=$` ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•°ã§ã‚­ãƒ¼å…¥åŠ›å–å¾—
2. âœ… Raw Modeã®å®‰å…¨ãªåˆ¶å¾¡
3. âœ… æ—¢å­˜GridRunnerã¨ã®çµ±åˆ

### éå¿…é ˆï¼ˆå¾Œå›ã—ï¼‰
- âŒ ç”»é¢åˆ†å‰²
- âŒ å·®åˆ†æç”»ï¼ˆã¾ãšã¯å…¨æ›´æ–°ã§OKï¼‰
- âŒ 30FPSåˆ¶å¾¡ï¼ˆã¾ãšã¯ç„¡åˆ¶é™ã§OKï¼‰
- âŒ ã‚«ãƒ©ãƒ¼å‡ºåŠ›

## ğŸ“ å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
src/
â”œâ”€â”€ realtime/                    # æ–°è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â”œâ”€â”€ KeyboardInput.ts        # Phase 1: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ç®¡ç†
â”‚   â”œâ”€â”€ GridDiffRenderer.ts     # Phase 2: å·®åˆ†æç”»
â”‚   â”œâ”€â”€ RealTimeRunner.ts       # Phase 3: ãƒ•ãƒ¬ãƒ¼ãƒ åˆ¶å¾¡
â”‚   â””â”€â”€ index.ts                # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
â”œâ”€â”€ workerInterpreter.ts        # K=$ ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•°è¿½åŠ 
â””â”€â”€ index.ts                    # CLIçµ±åˆ

__tests__/
â””â”€â”€ realtime/                    # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
    â”œâ”€â”€ KeyboardInput.test.ts
    â””â”€â”€ integration.test.ts

examples/
â””â”€â”€ realtime_tests/              # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¢
    â”œâ”€â”€ 01-key-echo.ws
    â”œâ”€â”€ 02-simple-game.ws
    â””â”€â”€ 03-animation.ws
```

## ğŸ® Phase 1 å®Ÿè£…ä¾‹ï¼ˆMVPï¼‰

### ã‚µãƒ³ãƒ—ãƒ«1: ã‚­ãƒ¼ã‚¨ã‚³ãƒ¼
```workerscript
: Key Echo Program
?="Press keys (ESC to exit)" /

^LOOP
    K=$
    ;=K>0 ?="Pressed: " ?=K /
    ;=K=27 #=^END
    #=^LOOP

^END
    ?="Goodbye!" /
    #=-1
```

### ã‚µãƒ³ãƒ—ãƒ«2: ç°¡æ˜“ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
```workerscript
: Counter with Keyboard Control
C=0
?="Press + to increment, - to decrement, ESC to exit" /

^LOOP
    K=$
    ;=K=43 C=C+1  : + key
    ;=K=45 C=C-1  : - key
    ;=K=27 #=^END : ESC
    
    ;=K>0 ?="Counter: " ?=C /
    
    #=^LOOP

^END
    ?="Final count: " ?=C /
    #=-1
```

## âœ… Phase 1 å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### è¨­è¨ˆ
- [ ] KeyboardInput ã‚¯ãƒ©ã‚¹è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼
- [ ] ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•° K ã®ä»•æ§˜ç¢ºå®š
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥æ±ºå®š

### å®Ÿè£…
- [ ] KeyboardInput.ts ä½œæˆ
- [ ] Raw Mode åˆ¶å¾¡å®Ÿè£…
- [ ] ã‚­ãƒ¼ãƒãƒƒãƒ•ã‚¡å®Ÿè£…
- [ ] çµ‚äº†å‡¦ç†å®Ÿè£…
- [ ] WorkerInterpreter ã« K=$ è¿½åŠ 
- [ ] GridRunner ã¨ã®çµ±åˆ

### ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] æ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼ˆå®Ÿéš›ã®ã‚­ãƒ¼å…¥åŠ›ï¼‰
- [ ] ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ç¢ºèªï¼ˆCtrl+C, éTTYç’°å¢ƒï¼‰

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ ] API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ ] ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ï¼ˆ3å€‹ä»¥ä¸Šï¼‰
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¬ã‚¤ãƒ‰æ›´æ–°

## ğŸ¯ æˆåŠŸæŒ‡æ¨™ï¼ˆPhase 1ï¼‰

### æŠ€è¡“çš„
- [ ] ã‚­ãƒ¼å…¥åŠ›é…å»¶ < 50ms
- [ ] ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ç„¡ã—
- [ ] å®‰å…¨ãªçµ‚äº†ï¼ˆ100%æˆåŠŸï¼‰
- [ ] æ—¢å­˜ãƒ†ã‚¹ãƒˆå…¨ã¦ãƒ‘ã‚¹

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“
- [ ] ç›´æ„Ÿçš„ãªå‹•ä½œ
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãªå…¥åŠ›
- [ ] æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

## ğŸ“Š æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **Phase 1 å®Ÿè£…é–‹å§‹**: KeyboardInput.ts ã®éª¨æ ¼ä½œæˆ
2. **Raw Modeèª¿æŸ»**: Node.jsã§ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç¢ºèª
3. **ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ä½œæˆ**: æœ€å°é™ã®å‹•ä½œç¢ºèª
4. **çµ±åˆ**: WorkerInterpreter ã¸ã®çµ„ã¿è¾¼ã¿

---

**æœ€çµ‚ç›®æ¨™**: Phase 1å®Œäº†å¾Œã€å®Ÿéš›ã«å‹•ãã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªWorkerScriptãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒæ›¸ã‘ã‚‹çŠ¶æ…‹ã«ã™ã‚‹
