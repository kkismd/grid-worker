# CASランダムウォーカーの実装

## 概要

Compare-And-Swap (CAS) 操作を使用して、複数のワーカーが4x4フィールド内を安全に移動するサンプルスクリプト。
CASにより、複数ワーカーの同時移動時の衝突を検出し、グリッドの整合性を保証します。

## 仕様

### フィールド
- **サイズ**: 4x4 (座標 0,0 から 3,3)
- **初期状態**: 全てゼロ（空）

### ワーカーの動作

1. **初期化**
   - ワーカーの値: 128-254のランダム値（このサンプルでは固定値）
   - 初期位置: ランダム（0-3の範囲）
   - 初期方向: ランダム（0=上, 1=右, 2=下, 3=左）
   - 初期位置に自分の値を配置

2. **移動ループ**
   1. **方向転換判定**
      - 進む方向がフィールド外の場合は必ず方向転換
      - フィールド内でも1/4の確率で方向転換（実装では簡略化）
   
   2. **次の位置の確認**
      - 進む方向に座標を1マス移動
      - その位置のグリッド値をチェック
   
   3. **移動の試行**
      - 値が0の場合:
        - CASで自分の値をセット
        - 成功: 元の位置をゼロにして移動完了
        - 失敗: 衝突メッセージを表示してHALT
      - 値が0でない場合:
        - 別の方向を試す（最大4方向）
   
   4. **行き止まり判定**
      - 4方向全て試して移動不可の場合
      - 行き止まりメッセージを表示してHALT

## ファイル構成

### cas_random_walker.ws
- **ワーカー値**: 150
- **初期位置**: (0, 0)
- **初期方向**: 右（1）
- 詳細なコメント付き

### cas_random_walker2.ws
- **ワーカー値**: 200
- **初期位置**: (3, 3)
- **初期方向**: 上（0）
- コンパクト版

## 使用例

### 単一ワーカーの実行
```bash
npm run cli examples/cas_random_walker.ws -- -m 100
```

### 複数ワーカーの同時実行（将来対応）
複数のWorkerScriptインタプリタを協調的に実行することで、
真のマルチワーカー環境でのCAS動作を確認できます。

```bash
# ワーカー1とワーカー2を同時実行（概念例）
npm run cli examples/cas_random_walker.ws &
npm run cli examples/cas_random_walker2.ws &
```

## 技術的詳細

### CAS操作の使用
```workerscript
A=<&0,M>  : Grid[X,Y]が0ならMをセット、Aに結果（1=成功, 0=失敗）
```

### アトミック性の保証
- WorkerScriptは協調的マルチタスク（Generator）で実装
- 1ステートメント内で読み取り・比較・書き込みが完了
- 他のワーカーによる割り込みなし

### 衝突検出
CAS失敗時、他のワーカーが先に同じマスに移動したことを検出：
```workerscript
^DO_CAS
    A=<&0,M>
    ;=A=1 #=^CAS_SUCCESS
    
    : 失敗 = 衝突
    ?="COLLISION at (" ?=X ?="," ?=Y ?=")" /
    #=-1
```

## 制限事項

1. **ランダム性**
   - 現在のWorkerScriptにはランダム関数がない
   - 方向転換の「ランダム性」は簡略化されている
   - 実際のランダム動作には拡張が必要

2. **初期位置の重複**
   - 複数ワーカーが同じ初期位置から開始する可能性
   - 実運用では初期位置の調整が必要

3. **実行時間**
   - 行き止まりになるまで無限ループ
   - `--max-steps`オプションで制限推奨

## 期待される動作

### 正常動作
```
Walker 150 started at (0,0)
Moved to (1,0)
Moved to (2,0)
Moved to (2,1)
...
```

### 衝突検出
```
Walker 150 started at (0,0)
Moved to (1,0)
COLLISION at (1,1)
```
→ 別のワーカーが先に(1,1)に移動した

### 行き止まり
```
Walker 150 started at (0,0)
Moved to (1,0)
DEAD END at (1,0)
```
→ 全方向が埋まっている

## 今後の拡張

1. **ランダム関数の追加**
   - 真のランダム方向選択
   - ランダム初期位置生成

2. **統計情報の出力**
   - 移動回数
   - 衝突回数
   - 実行時間

3. **可視化の改善**
   - リアルタイムモードでの表示
   - 色分けされたワーカー表示

## 関連ドキュメント

- [CAS実装仕様](../docs/feature/grid-atomic-operations/IMPLEMENTATION.md)
- [WorkerScript言語仕様](../docs/deprecated_docs/worker.md)
- [協調的マルチタスク](../docs/spec.md)
