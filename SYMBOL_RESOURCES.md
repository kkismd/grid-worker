# WorkerScript 記号リソース管理表

## 概要

VTL言語拡張において、ASCII記号は貴重なリソースです。この文書では現在の使用状況と将来の拡張計画を体系的に管理します。

## ASCII記号使用状況一覧

### 🔴 使用済み記号（変更不可）

#### コマンド・制御構造
| 記号 | 用途 | 例 | 備考 |
|------|------|-----|------|
| `?` | 出力命令 | `?=100` | トランスクリプト出力 |
| `;` | IF文 | `;=A>5 ?=A` | 条件分岐 |
| `@` | NEXT文 | `@=I` | FORループ終了 |
| `/` | 改行出力 | `/` | 独立したステートメント |

#### 演算子
| 記号 | 用途 | 例 | 備考 |
|------|------|-----|------|
| `+` | 加算 | `A+B` | 算術演算子 |
| `-` | 減算 | `A-B` | 算術演算子、単項マイナス |
| `*` | 乗算 | `A*B` | 算術演算子 |
| `/` | 除算 | `A/B` | 算術演算子（改行出力と兼用） |
| `%` | 剰余 | `A%B` | 算術演算子 |
| `=` | 代入・比較 | `A=B`, `A=B` | 文脈で判別 |
| `>` | 大なり | `A>B` | 比較演算子 |
| `<` | 小なり | `A<B` | 比較演算子 |
| `>=` | 以上 | `A>=B` | 複合比較演算子 |
| `<=` | 以下 | `A<=B` | 複合比較演算子 |
| `<>` | 不等 | `A<>B` | 複合比較演算子 |
| `&` | 論理AND | `A&B` | 論理演算子 |
| `\|` | 論理OR | `A\|B` | 論理演算子 |
| `!` | 論理NOT | `!A` | 単項論理演算子 |

#### システム変数・制御
| 記号 | 用途 | 例 | 備考 |
|------|------|-----|------|
| `#` | プログラムポインタ | `#=^LABEL`, `#=!` | GOTO・HALT・RETURN制御 |
| `~` | ランダム数 | `A=~` | 0-32767のランダム値 |
| `` ` `` | グリッドアクセス | `` A=` `` | PEEK/POKE操作 |
| `!` | GOSUB命令・RETURN値 | `!=^SUB`, `#=!` | サブルーチン呼び出し・復帰 |
| `$` | 文字I/O | `$=65` | 1バイトデータ出力 |

#### 区切り・括弧
| 記号 | 用途 | 例 | 備考 |
|------|------|-----|------|
| `,` | 区切り | `I=1,100,2` | FOR文パラメータ区切り |
| `(` | 左括弧 | `(A+B)*C` | 式の優先順位 |
| `)` | 右括弧 | `(A+B)*C` | 式の優先順位 |
| `^` | ラベルプリフィックス | `^START` | ラベル定義 |
| `:` | コメント | `: comment` | 行コメント |
| `"` | 文字列区切り | `"Hello"` | 文字列リテラル |
| `'` | 文字リテラル | `'A'` | 単一文字（ASCII値） |

### 🟡 拡張提案済み記号

#### 配列・メモリアクセス（CORE_EXTENSIONS.md）
| 記号 | 提案用途 | 例 | 状態 |
|------|----------|-----|------|
| `{` | メモリアクセス開始 | `{A+5}=100` | 修正提案 |
| `}` | メモリアクセス終了 | `B={A+5}` | 修正提案 |
| `]` | **利用可能に** | - | RETURN文廃止により解放 |

#### 拡張コマンド（CORE_EXTENSIONS.md）
| 記号 | 提案用途 | 例 | 状態 |
|------|----------|-----|------|
| `\` | 拡張コマンド | `\MAX=A,B` | 修正提案 |
| `&` | **利用可能に** | - | 論理ANDは維持、コマンドは`\`に変更 |

### 🟢 利用可能記号（未使用）

| 記号 | ASCII | 備考 | 拡張候補用途 |
|------|-------|------|-------------|
| `]` | 93 | 右角括弧 | **新規利用可能** (RETURN廃止により) |
| `&` | 38 | アンパサンド | **部分利用可能** (論理AND維持、コマンド用途は`\`に) |
| `_` | 95 | アンダースコア | システム変数プリフィックス |

## 🔄 言語改善提案（現状の合理化）

### 1. 不等号の統一: `#` 削除
**現状**: `A<>B` と `A#B` が同義で冗長
**提案**: `#` の不等号用途を廃止、`<>` に統一
**理由**: 記号リソースの節約、文法の簡潔化

### 2. RETURN文の統一: `#=!` 記法
**現状**: `!=^SUB` (GOSUB) vs `]` (RETURN) で不整合  
**提案**: `#=!` でRETURN文を表現
**理由**: 
- GOSUB/RETURNの対称性（`!` 記号で統一）
- `]` 記号を配列アクセスに解放
- より直感的な「戻り先(`#`)を呼び出し元(`!`)に設定」の意味

### 改善による記号リソース効果
- **`#`**: 不等号廃止により負荷軽減
- **`]`**: 完全に利用可能に（配列アクセスの有力候補）
- **文法整合性**: GOSUB/RETURNが統一された記号体系に

## 修正された推奨配分計画

### フェーズ0: 既存言語の合理化
```
A<>B             → 不等号（#削除）
!=^SUB           → サブルーチン呼び出し  
#=!              → サブルーチン復帰（]廃止）
```

### フェーズ1: 配列・スタック機能  
**選択肢A**: `[address]` 記法（`]` 解放により可能）
```
[A+5] = 値       → メモリ書き込み
値 = [A+5]       → メモリ読み込み
```
**選択肢B**: `{address}` 記法（より安全）
```
{A+5} = 値       → メモリ書き込み
値 = {A+5}       → メモリ読み込み
```

### フェーズ2: 拡張コマンド機能
```
\COMMAND=args    → 拡張コマンド実行
```
- `\` を拡張コマンドプリフィックスに使用

### フェーズ3: システム変数拡張
```
S = value        → システム予約変数（推奨）
```
- シンプルな予約変数方式を継続

## 記号利用優先度（改善後）

| 優先度 | 記号 | 用途 | 状況 |
|--------|------|------|------|
| 最高 | `[` `]` | 配列アクセス | 解放により利用可能 |
| 高 | `{` `}` | 配列アクセス代替 | バックアップ案 |
| 高 | `\` | 拡張コマンド | 安全に利用可能 |
| 中 | `_` | システム変数 | 将来拡張用 |

## 📊 変更コスト見積もり結果

### `#` 不等号廃止の変更コスト: **極低** ⭐
**実際の使用例**: 0件（文書上の仮定のみ）
**必要な作業**:
1. レキサー (`src/lexer.ts`): `#` 不等号処理の削除
2. 文書 (`worker.md`): 不等号は `<>` のみと明記
3. 影響範囲: なし

### `]` RETURN廃止の変更コスト: **低** ⭐⭐
**実際の使用例**: 0件（仕様は存在するが実際のコードでは未使用）
**必要な作業**:
1. 仕様変更 (`worker.md`): `]` → `#=!` 
2. 実装変更 (`src/workerInterpreter.ts`): RETURNステートメント処理の変更
3. テスト更新 (`__tests__/workerInterpreter.test.ts`): テストケースの更新  
4. AST定義: 変更不要（内部処理のみ）

### 総合変更コスト: **低い** 
- サンプルコードへの影響なし（GOSUB/RETURN未使用）
- 破壊的変更だが実用への影響は最小限
- 記号リソース解放による将来の拡張性向上

---
*最終更新: 2025年10月18日*
*参照: CORE_EXTENSIONS.md, worker.md, src/lexer.ts*
*コスト調査: examples/*.ws, src/workerInterpreter.ts, __tests__/*